<?php
/**
 * Created by PhpStorm.
 * User: juan
 * Date: 16/07/19
 * Time: 13:24
 */

namespace app\modules\ivr\v1\models;



use app\modules\config\models\Config;
use app\modules\sale\models\Bill;
use app\modules\sale\models\Product;
use app\modules\sale\modules\contract\models\Contract;
use app\modules\westnet\models\Connection;
use function foo\func;

class Customer extends \app\modules\sale\models\Customer
{

    public function fields()
    {

        if ($this->scenario === 'full'){
            return [
                'customer_id',
                'fullName' => function($model) {
                    return ucwords(strtolower($this->lastname .', '. $this->name));
                },
                'document_type_id' => function ($model) {
                    return $model->documentType->document_type_id;
                },
                'document_type_name' => function ($model) {
                    return $model->documentType->name;
                },
                'document_number',
                'code',
                'payment_code',
                'phone',
                'phone2',
                'phone3',
                'phone4',
                'last_update' => function($model){
                    if($model->last_update) {
                        return \Yii::$app->formatter->asDate($model->last_update, 'dd-MM-yyyy');
                    } else {
                        return "false";
                    }
                },
                'needsUpdate' => function($model){
                    if ($model->needsUpdate) {
                        return "true";
                    }

                    return "false";
                },
                'contract_id' => function($model) {
                    $contract = $model->getContracts()->andWhere(['status' => Contract::STATUS_ACTIVE])->one();
                    if($contract){
                        return $contract->contract_id;
                    }

                    return '';
                },
                'services_address' => function($model) {
                    $contract = $model->getContracts()->andWhere(['status' => Contract::STATUS_ACTIVE])->one();
                    if($contract){
                        return ($contract->address ? $contract->address->shortAddress : $model->address);
                    }

                    return '';
                },
                'fibra' => function($model) {
                    $contract = $model->getContracts()->andWhere(['status' => Contract::STATUS_ACTIVE])->orWhere(['status' => Contract::STATUS_LOW_PROCESS])->one();
                    if($contract) {
                        if($contract->hasFibraPlan()) {
                            return "true";
                        }

                        return "false";
                    }

                    return "false";
                },
                'balance' => function($model){
                    return $model->current_account_balance;
                },
                'last_payment_amount' => function($model) {
                    $account = $model->accountInfo();
                    return $account['last_payment']['amount'];
                },
                'last_payment_date' => function($model) {
                    $account = $model->accountInfo();
                    return $account['last_payment']['date'];
                },
                'clipped' => function($model) {
                    if ($model->hasClippedForDebt()) {
                        return 'disabled';
                    }

                    return 'enabled';
                },
                'low_process' => function($model) {
                    $contract = $model->getContracts()->andWhere(['status' => Contract::STATUS_LOW_PROCESS])->one();
                    if($contract){
                        return "true";
                    }
                    return "false";
                }
            ];
        }else {
            return [
                'customer_id',
                'fullName',
                'documentType',
                'document_number',
                'code',
                'payment_code'
            ]; // TODO: Change the autogenerated stub
        }
    }

    public function accountInfo() {
        $data = [];

        $current_balance = round($this->current_account_balance, 2);

        $lastPayment = Payment::find()->andWhere(['customer_id' => $this->customer_id])->orderBy(['timestamp' => SORT_DESC])->one();

        $data['balance'] = ($current_balance !== null ? $current_balance : 0);

        if($lastPayment) {
            $data['last_payment'] = $lastPayment;
        }else {
            $data['last_payment'] = [
                'amount' => 0,
                'date' => '00-00-0000'
            ];
        }

        return $data;
    }

    public function extendConnetionInfo()
    {
        $payment_extension_product = Product::findOne(Config::getValue('extend_payment_product_id'));

        $contracts = [
            'contract_id' => '',
            'service_address' => '',
        ];
        $payment_extension_requested = $this->getPaymentExtensionQtyRequest();
        $contract = $this->getContracts()->andWhere(['status' => Contract::STATUS_ACTIVE])->one();

        if ($contract) {
            $contracts = [
                'contract_id' => $contract->contract_id,
                'service_address' => $contract->address ? $contract->address->fullAddress : $this->address,
            ];
        }


        if (empty($payment_extension_product)) {
            $price = 0;
        }else {
            $price = round($payment_extension_product->finalPrice, 2);
        }

        $payment_extension_info = [
            'code' => $this->code,
            'contracts' => $contracts,
            'price' => $price,
            'from_date' => (new \DateTime('now'))->format('d-m-Y'),
            'to_date' =>(new \DateTime('now'))->setTimestamp(\app\modules\sale\models\Customer::getMaxDateNoticePaymentExtension())->format('d-m-Y'),
        ];

        return $payment_extension_info;
    }

    public function hasClippedForDebt() {

        $clipped = false;
        $contracts = $this->contracts;

        foreach ($contracts as $contract) {
            if ($contract->connection && $contract->connection->status_account === Connection::STATUS_ACCOUNT_CLIPPED) {
                $clipped = true;
            }
        }

        return $clipped;
    }

    public function hasContractAndConnectionActive()
    {
        return $this->getContracts()->andWhere(['status' => Contract::STATUS_ACTIVE])->exists();
    }

    /**
     * Indica si posee un contrato activo o en proceso de baja
     */
    public function hasActiveOrLowProcessContract()
    {
        return $this->getContracts()
            ->andWhere(['status' => Contract::STATUS_ACTIVE])
            ->orWhere(['status' => Contract::STATUS_LOW_PROCESS])
            ->exists();
    }
}